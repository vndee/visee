<!doctype html>
<html lang="en-US">
<head>
    {% load static %}
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Product seeker</title>
	<link href="{% static 'css/singlePageTemplate.css' %}" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
	<link
        rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
        crossorigin="anonymous"
    >
    <link rel="stylesheet" href="{% static 'static/css/jquery.Jcrop.css' %}" type="text/css" />



    <style>
        #logo {
            height: 100%;
            /* height: 100px; */
            /* width: 100px; */
            background-image: url("{% static 'images/logo.png' %}") !important;
            background-size: 170px !important;
            background-repeat: no-repeat;
            cursor: pointer;
            
        }        

    </style>
</head>
<body>
    <!-- modal -->
    <div id="overlay"></div>

    <div id='crop-img-zone'>
        <div id='crop-img-zone-header'>
            <div id="title">Crop image</div>
			<div id="close-button">&times;</div>
        </div>
        <div id='crop-img-zone-body'>
            <div style="display: flex; justify-content: space-between;">
                <div style="display: flex;">
                    <input type="file" style="max-width: 85px; font-size: 13px;" onchange="previewImage(event)">
                    <div id="crop_button"></div>
                </div>
                <div id="submit-crop"></div>
            </div>
            <div align="center">
                <div id="image-field"></div>
				<img src="#" id="target" style="max-height: 380px; max-width: 450px;" />
			</div>
        </div>
    </div>
    <!-- modal -->

        
    <div class="row" id="header" style="height: 80px;  margin: 0; align-items: center; display: flex;">

            <div id="logo" class="col-md-2 col-sm-3" style="text-align: center;">
            </div>
        <div id="sz" class="col-md-10 col-sm-9" >
            <div style="border: 1px solid rgba(190, 190, 190, 0.548); height: 40px; border-radius: 45px; width: 580px; max-width: 100%; display: flex; align-items: center; justify-content: space-between;">
                <input
                        id="text-search"
                        style="width: 75%;
                        margin: 0px 10px 0px 20px;
                        font-size: 16px;"
                        value="{{search_text}}"
                >
                <div style="display: flex; margin: 0px 20px 0px 10px;">
                    <div id='ims'></div>
                    <div id='sbt'></div>
                </div>
            </div>
        </div>
    </div>


    <div id="option" class="row"  style="margin: 0; border-bottom: 0.5px solid rgba(59, 59, 59, 0.322);">
        <div class="col-md-2 col-sm-3" style="padding: 0;">
        <p></p>
        </div>
        <div style="height: 40px; display: flex; align-items: flex-end; margin-bottom: 1%">
            <select id="select-price" class="form-control" style="margin-right: 3%">
                <option value="" disabled selected hidden>Price</option>
                <option value="Increase">Increase</option>
                <option value="Decrease">Decrease</option>
            </select>
            <select id="select-seller" class="form-control" >
                <option value="" disabled selected hidden>Seller</option>
                <option value="Tiki">Tiki</option>
                <option value="Lazada">Lazada</option>
            </select>
        </div>
    </div>

    <div class="container">
        <div id="track"><span id="num-result"></span> results in <span id="time">{{time_process}}s</span></div>

        <div class="resultlist"></div>
    </div>

    <div  id="page" style="text-align: center;"></div>

    <div style="height: 40px;"></div>

    <div id="footer" style="background-color: rgba(243, 239, 239, 0.26); position: static; bottom: 0; left: 0; right: 0;" align="center">&copy;2019 DIMEST</div>

	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script>

	var data = {{res_text|safe}};

	// console.log(data.hits.length);
	var item;
    var data_length = data.hits.length;

    $("#num-result").text(data_length);

    var crr_index = 1;
    var num_result_each = 5;

    var num_char_des = 125;
    
    function makePageIndex() {
        for (i = 1; i <= Math.ceil(data_length/num_result_each); i++) {
            $("#page").html($("#page").html() + "<span class='index'>" + i + "</span>");
        }
    }

    makePageIndex();
    
    document.getElementsByClassName("index")[0].classList.add("active");

    $(".index").click(function (event) {
            crr_index = event.currentTarget.textContent;
            $(".index").each(function() {
                $(this).removeClass("active");
            });
            event.currentTarget.classList.add("active");
            show_result();

            if ($(document).height() == $(window).height()) {
                $("#footer").css("position", "fixed");
            } else {
                $("#footer").css("position", "static");
            }

        })
    show_result();

    function show_result() {
        $(".resultlist").html("");
        for (i = num_result_each*crr_index - num_result_each; i < num_result_each*crr_index && i < data_length; i++) {
            // item = ;
            item = ((ls_index === undefined || ls_index.length == 0))?data.hits[i]:data.hits[ls_index[i]];

            src_image = item._source.images[0];
            link = item._source.link;
            dis_link = link.substr(0, 45);
            title = item._source.title;
            description = item._source.description;
            dis_des = description.substr(0, num_char_des);
            if (description.length > num_char_des) {
                dis_des += "<span onclick='seemore(event)' class='see'> ...see more</span>";
            }
            price = item._source.price;
            status = item._source.domain;
            
            var resultItem ="<div class='row item'>"
            resultItem +=    "<div class='col-md-2 item-img'><img src='" + src_image + "'></div>"
            
            resultItem +=    "<div class='col-md-10 item-content'>"
            resultItem +=        "<div class='item-content-title'>" + title + "</div>"
            resultItem +=        "<div class='item-content-value'>"
            resultItem +=           "<div class='item-content-value-price'>Price: " + price + "</div>"
            resultItem +=           "<div class='item-content-value-link'><a href='" + link + "'>" + dis_link + "</a></div>"
            resultItem +=        "</div>"
            resultItem +=        "<div data-value='" + description +"' class='item-content-des'>" + dis_des + "</div>"
            resultItem +=    "</div>"
            resultItem +="</div>"
            resultItem +="<p></p>"
            

            $(".resultlist").html($(".resultlist").html() + resultItem);
            
        }
    }

    function seemore(event) {
        var span = event.currentTarget
        var crr_des = span.parentNode;
        crr_des.textContent = crr_des.getAttribute("data-value");
        crr_des.innerHTML += "<span onclick='seeless(event)' class='see'> show less</span>";
    }

    function seeless(event) {
        var span = event.currentTarget
        var crr_des = span.parentNode;
        crr_des.textContent = crr_des.getAttribute("data-value").substr(0, num_char_des);
        crr_des.innerHTML += "<span onclick='seemore(event)' class='see'> ...see more</span>";
    }
    
    $('#ims').click(function () {
        $('#overlay').addClass('active');
        $('#crop-img-zone').addClass('active');
    })

    $('#close-button').click(function() {
        $('#overlay').removeClass('active');
        $('#crop-img-zone').removeClass('active');
    })

    var filter = ""; 
    var filterPrice = "";
    var filterSeller = "";
    var ls_index = [];

    function sort() {
        var minPrice = 1000000000000;
        var border = 0;
        var itemPrice;

        while (ls_index.length < data_length) {

            for (i = 0; i < data.hits.length;i++) {
                itemPrice = parseFloat(data.hits[i]._source.price.substr(0, data.hits[i]._source.price.length - 2));
                if(minPrice > itemPrice && itemPrice > border)
                    minPrice = itemPrice
                    
            }

            for (i = 0; i < data.hits.length;i++) {
                itemPrice = parseFloat(data.hits[i]._source.price.substr(0, data.hits[i]._source.price.length - 2));
                if(minPrice == itemPrice)
                    ls_index.push(i);
            }

            border = minPrice;
            minPrice = 1000000000000;
        }
    }

    function filterResult() {
        filter.split(",").forEach(element => {
            switch(element) {
                case "Increase":
                    sort();
                    show_result();
                    break;
                case "Decrease":
                    sort();
                    ls_index = ls_index.reverse();
                    show_result();
                    break;
                case "Tiki":
                    console.log(element)
                    break;
                case "Lazada":
                    console.log(element)
                    break;
                default:
                    // code block
            }
        });
    }

    $('#select-price').change(function() {
        filterPrice = this.value;
    })

    $('#select-seller').change(function() {
        filterSeller = this.value;
    })

    $('select').change(function() {
        filter = filterPrice + (((filterSeller.length != 0) && (filterPrice.length != 0))?",":"") + filterSeller;
        filterResult();
    })
    
    function search(typeRequest) {
        var query;

        if (typeRequest == "text") {
            query = $("#text-search").val();
        }
        else {
            query = document.getElementById("target").src;
        }

        var data = {
            "api_key": "put your damn api key here!",
            "engine" : typeRequest,
            "query" : query
        }

        var request = {
            method : "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body : JSON.stringify(data)
        }

        fetch(url, request).then(res => res.json()).then(res => {
            result = res;
            console.log(result);
            localStorage.setItem("result", JSON.stringify(result));
            return res;
        });
    }

    var url = "";
    var result;

    

    $("#sbt").click(function () {
        if (url == "") 
            alert("Put your damn url first");
        
        search("text")
    });

    $("#submit-crop").click(function () {
        if (url == "") 
            alert("Put your damn url first");
        
        search("visual")
    });

    $("#text-search").focusin(function(input) {
            $("#text-search").keydown(function(e) {
                if (e.keyCode == 13) {
                    alert("Do later!");
                }
            });
        });
    </script>

    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/jquery.Jcrop.min.js' %}"></script>
    <script src="{% static 'js/image-clipper.js' %}"></script>
    <script src="{% static 'js/jquery.Jcrop.js' %}"></script>
	<script src="{% static 'js/crop_image.js' %}"></script>
</body>
</html>
